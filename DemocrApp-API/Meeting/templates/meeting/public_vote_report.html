{% extends "meeting/reports/_base.html" %}

{% block title %}{{ vote.name | safe }} - Public Vote Report{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="mb-1">{{ vote.name | safe }}</h1>
        {% if vote.description %}
        <p class="text-muted">{{ vote.description | safe }}</p>
        {% endif %}
        <p class="text-muted mb-0">
            <span class="badge bg-secondary">{{ vote.get_method_display }}</span>
            <span class="badge bg-info">{{ vote.responses }} responses</span>
        </p>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="fa fa-bar-chart"></i> Results</h5>
    </div>
    <div class="card-body">
        {{ vote.results | safe }}
    </div>
</div>

<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="fa fa-list"></i> Individual Ballots</h5>
        <small class="text-muted">Ballots are listed in random order to protect voter privacy</small>
    </div>
    <div class="card-body">
        {% if vote.method == 'YNA' %}
        <table class="table table-sm table-hover">
            <thead class="table-light">
                <tr>
                    <th>Ballot</th>
                    <th>Vote</th>
                </tr>
            </thead>
            <tbody>
                {% for ballot in ballots %}
                <tr>
                    <td>{{ ballot.id }}</td>
                    <td><span class="badge {% if ballot.option.name == 'yes' %}bg-success{% elif ballot.option.name == 'no' %}bg-danger{% else %}bg-secondary{% endif %}">
                        {{ ballot.option.name | title }}
                    </span></td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="2" class="text-muted">No ballots recorded.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        {# STV ballots - group by ballot #}
        <table class="table table-sm table-hover">
            <thead class="table-light">
                <tr>
                    <th>Ballot</th>
                    <th>Preferences</th>
                </tr>
            </thead>
            <tbody>
                {% regroup ballots by id as ballot_groups %}
                {% for group in ballot_groups %}
                <tr>
                    <td>{{ group.grouper }}</td>
                    <td>
                        {% for pref in group.list %}
                        <span class="badge bg-secondary">{{ pref.value }}. {{ pref.option.name }}</span>
                        {% endfor %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="2" class="text-muted">No ballots recorded.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}
    </div>
</div>

<div class="alert alert-info">
    <i class="fa fa-info-circle"></i> This is a public report. Individual voter identities are not disclosed to protect ballot secrecy.
</div>
{% endblock %}
